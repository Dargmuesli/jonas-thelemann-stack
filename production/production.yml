secrets:
  traefik_cf-api-email:
    external: true
  traefik_cf-api-key:
    external: true
services:
  jonas-thelemann:
    image: dargmuesli/jonas-thelemann:3.0.0
    user: (( prune ))
    volumes:
    - (( replace ))
    - ./secrets/jonas-thelemann/jonas-thelemann.env:/var/www/jonas-thelemann/credentials/jonas-thelemann.env:ro
    - jonas-thelemann_data:/var/www/jonas-thelemann/
    - acme_data:/etc/ssl/certificates/
  jonas-thelemann_nginx:
    volumes:
    - (( replace ))
    - ./configuration/jonas-thelemann_nginx/nginx.conf:/etc/nginx/nginx.conf
    - jonas-thelemann_data:/var/www/jonas-thelemann/
    - acme_data:/etc/ssl/certificates/
  traefik:
    command:
    - (( prepend ))
    - --acme.acmeLogging=true
    - --acme.dnsChallenge.provider=${STACK_ACME_PROVIDER}
    - --acme.domains=${STACK_DOMAIN},1generator.${STACK_DOMAIN},adminer.${STACK_DOMAIN},codimd.${STACK_DOMAIN},nextcloud.${STACK_DOMAIN},randomwinpicker.${STACK_DOMAIN},traefik.${STACK_DOMAIN},www.${STACK_DOMAIN}
    - --acme.email=${STACK_ACME_EMAIL}
    - --acme.entrypoint=https
    - --acme.storage=/etc/traefik/acme/acme.json
    environment:
      # For other providers see:
      # https://docs.traefik.io/configuration/acme/#provider
      CF_API_EMAIL_FILE: /run/secrets/traefik_cf-api-email
      CF_API_KEY_FILE: /run/secrets/traefik_cf-api-key
    secrets:
    - traefik_cf-api-email
    - traefik_cf-api-key
  traefik_certs-dumper:
    image: ldez/traefik-certs-dumper:v2.6.0
    command:
    - file
    - --clean=false
    - --crt-name="$STACK_DOMAIN"
    - --dest=/etc/traefik/acme/
    - --key-name="$STACK_DOMAIN"
    - --post-hook=/mnt/traefik_certs-dumper/post-hook $STACK_DOMAIN
    - --source=/etc/traefik/acme/acme.json
    - --watch
    environment:
      STACK_DOMAIN: ${STACK_DOMAIN}
    volumes:
    - acme_data:/etc/traefik/acme/
    - ./configuration/traefik_certs-dumper/post-hook:/mnt/traefik_certs-dumper/post-hook
volumes:
  acme_data: {}
  jonas-thelemann_data: {}
